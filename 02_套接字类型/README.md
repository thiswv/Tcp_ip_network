## 套接字类型与协议设置

### 2.1 套接字协议及其数据传输特性

#### 什么叫协议？  

> 简单来说就是通信时要遵循的规则  
>
> 比如你用微信给B发信息，那么B也需要用微信接受消息，而不是QQ  

#### 详解创建套接字  

首先来看之前在第一章已经出现过的函数  

```c
#include <sys/socket.h>

int socket(int domain, int type, int protocol);

成功时返回文件描述符，失败返回-1
```

> 1. domian    套接字中使用的协议族信息  
> 2. type      套接字数据传输类型信息  
> 3. protocol  计算机间通信中使用的协议信息  

#### 什么叫协议族？ (Protocol Family)  

宽面和细面都是面条的一种  

与之类似，套接字通信中的协议也具有一些分类  

如大家熟知的IPV4和IPV6都是通信的一种方式  

所以，通过socket函数的第一个参数传递套接字中使用的协议分类信息
，**此协议分类信息陈称为议族**  

| 名称  | 协议族  |
|---|---|
| PF_INET  | IPv4互联网协议族  |
| PF_INET6  | IPv6互联网协议族  |
| PF_LOCAL  | 本地通信的UNIX协议族  |
| PF_PACKET  | 底层套接字的协议族  |
| PF_IPX  | IPX NOvell协议族  |

不过本书的重点在**PF_INET**上，也就是重点讲IPv4  

其次，套接字中实际采用的最终协议信息是通过socket函数的第三个参数传递的

记住**在指定的协议族范围内通过第一个参数决定第三个参数**

#### 套接字类型（type）

为什么要将套接字类型嗯，因为，同一种协议族类可能会有多种数据传输方式  

就是说决定了协议族，**并不能决定数据的传输方式**  

#### 介绍两种PF_INET的数据传输方式  

##### 面向连接的套接字(SOCK_STREAM)

如果socket函数第一个参数为PF_INET，第二个参数选择SOCK_STREAM，**则建立了面向连接的套接字**  

> 1. 传输过程中数据不会消失
> 2. 按序传输数据
> 3. 传输的数据没有数据边界

![2.1](2.1.png )

图中通过独立的传送带传输数据，只要传送带本身没有问题，那么数据就不会丢失。  

同时，较晚传输的数据不会先到达，因为传送带保证了数据的按序传递。  

其次我们可以观察到，假设有100颗糖果从前面的工人处传输给后一个工人。后面的工人是等收集完全部的100个糖果后才封装袋子。

因此，**面向连接的套接字不存在数据边界**  

由此我们可以类比到write和read中，在多次write向缓冲区写入数据后，我们只需要一次read就可以将数据全部读出。

> 因为收发数据的套接字内部有缓冲区，简而言之就是字节数组。
>  
> 通过套接字传输的数据将保存到该数组。
>  
> 因此就不会立刻就调用read，只要不超过缓冲区大小，就可以一直存储
>  
> 当然也可能多次read依次读出
>  
> 言而总之，在面向连接的套接字编程中，write和read的次数没有多大意义
>  
> 间接证明了面向连接的套接字编程没有数据边界。

最后，我们会发现图中传输和接收端各有1名工人说明**套接字连接必须一一对应**  

总结，面向连接的套接字是 ***可靠的、按序传递的、基于字节的面向连接的数据传输方式的套接字***

##### 知识补给

> 在上面我们回答到write可以一直写入缓冲区，只要不溢出
> read可以多次或一次读取，没有任何关系
> 那么问题来了，write一直写入，我一次都不去read或者是read的频率远远低于write，直到缓冲区溢出
> **那么数据会丢失吗？**
> 先说答案，不会
> 因为套接字将停止传播
> 套接字会根据接收端的状态传输数据，出错时还会提供重传服务。
> 因此，面向连接的套接字除特殊情况外是不会发生数据丢失的

##### 思考

> 竟然面向连接的套接字是有序的，那为什么**tcp在接受数据时还是会出现后一个数据比前一个先到呢**？
>  
> 因为它虽然有序，但是传输的快慢有差异。  
>  
> 传播过程中数据的丢失(主要是在发送和接受的时候)也会导致后面的数据但前面的还未到达。

##### 面向消息的套接字(SOCK_DGRAM)

![2.2](2.2.png)  

如图，面向消息的套接字传输过程可以比作高速移动的摩托车快递

> 1.强调快速传输而非传输顺序
> 2.传输的数据可能丢失也可能损毁
> 3.传输的数据有数据边界
> 4.限制每次传输的数据大小

众所周知，对于快递行业来说速度就是生命  

依次举例，对应上述四条规则

> 用摩托车发往同一目的地的2件包裹无需保证顺序，可需要快速交给客户即可
>  
> 快递必不能保证物品完整，且包裹大小有限制，因此大包裹需要变成小包裹发送
>  
> 如果，多个包裹由多个工人送达，需要多次接受，即拥有数据边界  

总结，面向消息的套接字 ***不可靠，无序，拥有数据边界，以高速为目的***  
